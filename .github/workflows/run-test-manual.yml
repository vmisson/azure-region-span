name: Run Test for Specific Regions

on:
  workflow_dispatch:  
    inputs:
      source:
        description: 'Azure region Source'
        required: true
        type: choice
        options:
          - australiaeast
          - belgiumcentral
          - brazilsouth
          - canadacentral
          - centralindia
          - centralus
          - chilecentral
          - eastasia
          - eastus
          - eastus2
          - francecentral
          - germanywestcentral
          - indonesiacentral
          - israelcentral
          - italynorth
          - japaneast
          - japanwest
          - koreacentral
          - malaysiawest
          - mexicocentral
          - newzealandnorth
          - northeurope
          - norwayeast
          - polandcentral
          - qatarcentral
          - southafricanorth
          - southcentralus
          - southeastasia
          - spaincentral
          - swedencentral
          - switzerlandnorth
          - uaenorth
          - uksouth
          - westeurope
          - westus2
          - westus3
      destination:
          description: 'Azure region Destination'
          required: true
          type: choice
          options:
            - australiaeast
            - belgiumcentral
            - brazilsouth
            - canadacentral
            - centralindia
            - centralus
            - chilecentral
            - eastasia
            - eastus
            - eastus2
            - francecentral
            - germanywestcentral
            - indonesiacentral
            - israelcentral
            - italynorth
            - japaneast
            - japanwest
            - koreacentral
            - malaysiawest
            - mexicocentral
            - newzealandnorth
            - northeurope
            - norwayeast
            - polandcentral
            - qatarcentral
            - southafricanorth
            - southcentralus
            - southeastasia
            - spaincentral
            - swedencentral
            - switzerlandnorth
            - uaenorth
            - uksouth
            - westeurope
            - westus2
            - westus3

env:
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_VAR_storage_account_name: ${{ secrets.TERRAFORM_STATE_SA }}
  TF_VAR_storage_account_resource_group: ${{ secrets.TERRAFORM_STATE_RG }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_resource_group_name: "rg-netperf-region-002"

jobs:
  infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.5

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

    - name: Open Storage Account Firewall
      run: |
        az storage account update \
          --resource-group "${{ secrets.TERRAFORM_STATE_RG }}" \
          --name "${{ secrets.TERRAFORM_STATE_SA }}" \
          --public-network-access Enabled \
          --default-action Allow
        # Wait a moment for the rule to take effect
        sleep 30

    - name: Terraform Init
      run: |
        terraform init \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="resource_group_name=${{ secrets.TERRAFORM_STATE_RG }}" \
          -backend-config="storage_account_name=${{ secrets.TERRAFORM_STATE_SA }}" \
          -backend-config="container_name=${{ secrets.TERRAFORM_STATE_CONTAINER }}" \
          -backend-config="key=infra-manual.tfstate"

    - name: Terraform Plan
      run: |
        terraform plan -var-file="tfvars/${{ inputs.source }}.tfvars" -var="deploy_infra=true" -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      continue-on-error: true

  server:
    name: Deploy Server
    runs-on: ubuntu-latest
    needs: infra

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.5

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

    - name: Terraform Init
      run: |
        terraform init \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="resource_group_name=${{ secrets.TERRAFORM_STATE_RG }}" \
          -backend-config="storage_account_name=${{ secrets.TERRAFORM_STATE_SA }}" \
          -backend-config="container_name=${{ secrets.TERRAFORM_STATE_CONTAINER }}" \
          -backend-config="key=server-manual.tfstate"

    - name: Terraform Plan
      run: |
        terraform plan -var-file="tfvars/${{ inputs.destination }}.tfvars" -var="deploy_server=true" -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      continue-on-error: true

  client:
    name: Deploy Client
    runs-on: ubuntu-latest
    needs: server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.5

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

    - name: Terraform Init
      run: |
        terraform init \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="resource_group_name=${{ secrets.TERRAFORM_STATE_RG }}" \
          -backend-config="storage_account_name=${{ secrets.TERRAFORM_STATE_SA }}" \
          -backend-config="container_name=${{ secrets.TERRAFORM_STATE_CONTAINER }}" \
          -backend-config="key=client-manual.tfstate"

    - name: Terraform Plan
      run: |
        terraform plan -var-file="tfvars/${{ inputs.source }}.tfvars" -var="deploy_client=true" -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      continue-on-error: true

  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: client
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.5

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'


    - name: Wait 5 minutes
      run: sleep 300      

    - name: Delete Resource Group
      if: always()
      run: |
        echo "Deleting resource group: ${{ env.TF_VAR_resource_group_name }}"
        az group delete --name "${{ env.TF_VAR_resource_group_name }}" --yes --no-wait || true
        echo "Resource group deletion command executed (may take time to complete)"

